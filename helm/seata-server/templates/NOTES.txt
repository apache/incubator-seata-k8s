#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

1. Get the application URL by running these commands:
{{- if .Values.ingress.enabled }}
  {{- range $host := .Values.ingress.hosts }}
    {{- range .paths }}
  http{{ if $.Values.ingress.tls }}s{{ end }}://{{ $host.host }}{{ .path }}
    {{- end }}
  {{- end }}
{{- else if contains "NodePort" .Values.seataServer.service.type }}
  export NODE_PORT=$(kubectl get services {{ include "seata-server.fullname" . }} -n {{ .Release.Namespace }} -o jsonpath="{.spec.ports[0].nodePort}")
  export NODE_IP=$(kubectl get nodes -o jsonpath="{.items[0].status.addresses[?(@.type=='ExternalIP')].address}")
  echo http://$NODE_IP:$NODE_PORT
{{- else if contains "LoadBalancer" .Values.seataServer.service.type }}
  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
  You can watch the status by running 'kubectl get --namespace {{ .Release.Namespace }} svc -w {{ include "seata-server.fullname" . }}'
  export SERVICE_IP=$(kubectl get svc --namespace {{ .Release.Namespace }} {{ include "seata-server.fullname" . }} --template "{{"{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}"}}")
  echo http://$SERVICE_IP:{{ .Values.seataServer.service.ports.console.port }}
{{- else if contains "ClusterIP" .Values.seataServer.service.type }}
  export POD_NAME=$(kubectl get pods --namespace {{ .Release.Namespace }} -l "app.kubernetes.io/name={{ include "seata-server.name" . }},app.kubernetes.io/instance={{ .Release.Name }}" -o jsonpath="{.items[0].metadata.name}")
  kubectl port-forward --namespace {{ .Release.Namespace }} $POD_NAME {{ .Values.seataServer.service.ports.console.port }}:{{ .Values.seataServer.service.ports.console.port }}
  echo "Visit http://127.0.0.1:{{ .Values.seataServer.service.ports.console.port }}"
{{- end }}

2. Access Seata Console:
  - Username: {{ .Values.seataServer.env | first }}
  - Password: Check the secret {{ .Values.secret.name }}
    kubectl get secret {{ .Values.secret.name }} -n {{ .Release.Namespace }} -o jsonpath='{.data.password}' | base64 -d

3. Monitor the deployment:
  kubectl get seataserver -n {{ .Release.Namespace }}
  kubectl get pods -n {{ .Release.Namespace }} -l app=seata-server

4. Check logs:
  kubectl logs -f deployment/seata-server -n {{ .Release.Namespace }}

For more information, visit:
- https://seata.apache.org/
- https://github.com/apache/incubator-seata-k8s

